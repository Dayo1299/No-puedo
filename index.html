from flask import Flask, render_template_string, request, redirect, session, flash
import sqlite3
from datetime import datetime
import hashlib
import socket

app = Flask(__name__)
app.secret_key = 'tusecretoaquí'  # Cambia esto en producción!

# Configuración de la base de datos
def init_db():
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                 username TEXT UNIQUE,
                 password TEXT,
                 email TEXT,
                 balance REAL DEFAULT 0,
                 ref_code TEXT,
                 wallet_address TEXT,
                 joined_at TIMESTAMP)''')
    c.execute('''CREATE TABLE IF NOT EXISTS investments
                 (user_id INTEGER,
                 amount REAL,
                 plan TEXT,
                 date TIMESTAMP,
                 tx_hash TEXT,
                 status TEXT DEFAULT 'pending',
                 FOREIGN KEY(user_id) REFERENCES users(id))''')
    c.execute('''CREATE TABLE IF NOT EXISTS referrals
                 (referrer_id INTEGER,
                 referred_id INTEGER,
                 level INTEGER,
                 earnings REAL DEFAULT 0,
                 date TIMESTAMP,
                 FOREIGN KEY(referrer_id) REFERENCES users(id),
                 FOREIGN KEY(referred_id) REFERENCES users(id))''')
    c.execute('''CREATE TABLE IF NOT EXISTS withdrawals
                 (user_id INTEGER,
                 amount REAL,
                 wallet_address TEXT,
                 date TIMESTAMP,
                 status TEXT DEFAULT 'pending',
                 FOREIGN KEY(user_id) REFERENCES users(id))''')
    conn.commit()
    conn.close()

init_db()

# HTML Base con diseño profesional
base_html = """
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTOMAX PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6e48aa;
            --secondary: #9d50bb;
            --accent: #ff8a00;
            --dark: #1e1e2c;
            --darker: #121218;
            --light: #f5f6fa;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        body {
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #ddd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn {
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--accent), #e52e71);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid white;
            color: white;
        }
        .hero {
            text-align: center;
            padding: 80px 5%;
            background: url('https://images.unsplash.com/photo-1639762681057-408e52192e55?q=80&w=2232&auto=format&fit=crop') no-repeat center;
            background-size: cover;
            position: relative;
        }
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 44, 0.85);
        }
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
        }
        .hero h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        .container {
            padding: 60px 5%;
        }
        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        .plan-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .plan-card:hover {
            transform: translateY(-10px);
        }
        .plan-card h3 {
            color: #4cd137;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .plan-card .price {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--accent);
        }
        .plan-card ul {
            list-style: none;
            margin: 20px 0;
        }
        .plan-card ul li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 70px);
        }
        .sidebar {
            background: var(--darker);
            padding: 30px 20px;
        }
        .sidebar-nav {
            list-style: none;
        }
        .sidebar-nav li {
            margin-bottom: 15px;
        }
        .sidebar-nav a {
            color: var(--light);
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background: rgba(110, 72, 170, 0.3);
        }
        .main-content {
            padding: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
        }
        .stat-card h3 {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        .stat-card p {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }
        .text-center {
            text-align: center;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: rgba(76, 209, 55, 0.2);
            border: 1px solid #4cd137;
        }
        .alert-error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
        }
        .referral-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .referral-level {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
        }
        .referral-link {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin: 10px 0;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    {{ content | safe }}
</body>
</html>
"""

# Funciones útiles
def days_passed(date_str):
    date_obj = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
    return (datetime.now() - date_obj).days

def generate_ref_code(username, ip_address):
    # Genera un código único basado en username e IP
    hash_input = f"{username}{ip_address}{datetime.now().timestamp()}"
    return hashlib.md5(hash_input.encode()).hexdigest()[:8].upper()

def get_client_ip():
    if request.environ.get('HTTP_X_FORWARDED_FOR') is None:
        return request.environ['REMOTE_ADDR']
    else:
        return request.environ['HTTP_X_FORWARDED_FOR']

# Páginas
login_html = base_html.replace("{{ content | safe }}", """
<div class="hero">
    <div class="hero-content">
        <h1>Inicia Sesión en CRYPTOMAX</h1>
        <form method="post" style="max-width: 400px; margin: 0 auto;">
            <div class="form-group">
                <input type="text" name="username" class="form-control" placeholder="Usuario" required>
            </div>
            <div class="form-group">
                <input type="password" name="password" class="form-control" placeholder="Contraseña" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
            <p style="margin-top: 20px;">¿No tienes cuenta? <a href="/register" style="color: var(--accent);">Regístrate</a></p>
        </form>
    </div>
</div>
""")

register_html = base_html.replace("{{ content | safe }}", """
<div class="hero">
    <div class="hero-content">
        <h1>Únete a CRYPTOMAX</h1>
        <form method="post" style="max-width: 400px; margin: 0 auto;">
            <div class="form-group">
                <input type="text" name="username" class="form-control" placeholder="Usuario" required>
            </div>
            <div class="form-group">
                <input type="email" name="email" class="form-control" placeholder="Correo Electrónico" required>
            </div>
            <div class="form-group">
                <input type="password" name="password" class="form-control" placeholder="Contraseña" required>
            </div>
            <div class="form-group">
                <input type="password" name="confirm_password" class="form-control" placeholder="Confirmar Contraseña" required>
            </div>
            <div class="form-group">
                <input type="text" name="ref_code" class="form-control" placeholder="Código de Referido (opcional)">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Cuenta</button>
            <p style="margin-top: 20px;">¿Ya tienes cuenta? <a href="/login" style="color: var(--accent);">Inicia Sesión</a></p>
        </form>
    </div>
</div>
""")

dashboard_html = base_html.replace("{{ content | safe }}", """
<div class="dashboard">
    <div class="sidebar">
        <h3 style="margin-bottom: 30px; color: var(--accent);">CRYPTOMAX PRO</h3>
        <ul class="sidebar-nav">
            <li><a href="/dashboard" class="active">📊 Panel</a></li>
            <li><a href="/invest">💵 Invertir</a></li>
            <li><a href="/withdraw">🤑 Retirar</a></li>
            <li><a href="/referrals">👥 Referidos</a></li>
            <li><a href="/settings">⚙️ Configuración</a></li>
            <li><a href="/logout">🚪 Salir</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h1 style="margin-bottom: 30px;">Panel de Control</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Balance Actual</h3>
                <p>${{ '%.2f' | format(user.balance) }}</p>
            </div>
            <div class="stat-card">
                <h3>Ganancias Hoy</h3>
                <p>${{ '%.2f' | format(user.balance * 0.053) }}</p>
            </div>
            <div class="stat-card">
                <h3>Total Invertido</h3>
                <p>${{ '%.2f' | format(total_invested) }}</p>
            </div>
            <div class="stat-card">
                <h3>Referidos Activos</h3>
                <p>{{ referrals }}</p>
            </div>
        </div>

        <h2 style="margin: 30px 0 20px;">Tus Inversiones Activas</h2>
        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.1);">
                        <th style="padding: 15px; text-align: left;">Plan</th>
                        <th style="padding: 15px; text-align: left;">Monto</th>
                        <th style="padding: 15px; text-align: left;">Fecha</th>
                        <th style="padding: 15px; text-align: left;">Ganancias</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in investments %}
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px;">{{ inv.plan }}</td>
                        <td style="padding: 15px;">${{ '%.2f' | format(inv.amount) }}</td>
                        <td style="padding: 15px;">{{ inv.date }}</td>
                        <td style="padding: 15px; color: #4cd137;">${{ '%.2f' | format(inv.amount * 0.053 * days_passed(inv.date)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 40px; background: rgba(255,138,0,0.1); padding: 20px; border-radius: 10px; border-left: 4px solid var(--accent);">
            <h3 style="margin-bottom: 15px;">💡 Consejo Pro</h3>
            <p>Invita amigos y gana el 10% de sus ganancias en primer nivel, 3% en segundo nivel y 1% en tercer nivel. Tu código de referido es: <strong>{{ user.ref_code }}</strong></p>
        </div>
    </div>
</div>
""")

invest_html = base_html.replace("{{ content | safe }}", """
<div class="dashboard">
    <div class="sidebar">
        <h3 style="margin-bottom: 30px; color: var(--accent);">CRYPTOMAX PRO</h3>
        <ul class="sidebar-nav">
            <li><a href="/dashboard">📊 Panel</a></li>
            <li><a href="/invest" class="active">💵 Invertir</a></li>
            <li><a href="/withdraw">🤑 Retirar</a></li>
            <li><a href="/referrals">👥 Referidos</a></li>
            <li><a href="/settings">⚙️ Configuración</a></li>
            <li><a href="/logout">🚪 Salir</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h1 style="margin-bottom: 30px;">Realizar Inversión</h1>
        
        <div class="alert alert-error">
            <strong>ATENCIÓN:</strong> El mínimo de inversión es 1 USDT y el máximo es 1000 USDT. Envía exactamente el monto que deseas invertir.
        </div>
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px;">Dirección BEP20 para depósito:</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin: 15px 0; word-break: break-all;">
                0x91352C077fe12D22f75fed073D5dE2678b0bec01
            </div>
            <p>Red: Binance Smart Chain (BSC)</p>
        </div>
        
        <form method="post">
            <div class="form-group">
                <label>Monto invertido (USDT)</label>
                <input type="number" name="amount" class="form-control" min="1" max="1000" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Plan de inversión</label>
                <select name="plan" class="form-control" required>
                    <option value="Basic">Básico (4.2% diario)</option>
                    <option value="Premium" selected>Premium (5.3% diario)</option>
                    <option value="VIP">VIP (6.1% diario)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Hash de la transacción (TXID)</label>
                <input type="text" name="tx_hash" class="form-control" required placeholder="Ej: 0x123...abc">
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Registrar Inversión</button>
                <button type="button" class="btn btn-outline" onclick="window.location.href='/dashboard'">Cancelar</button>
            </div>
        </form>
    </div>
</div>
""")

withdraw_html = base_html.replace("{{ content | safe }}", """
<div class="dashboard">
    <div class="sidebar">
        <h3 style="margin-bottom: 30px; color: var(--accent);">CRYPTOMAX PRO</h3>
        <ul class="sidebar-nav">
            <li><a href="/dashboard">📊 Panel</a></li>
            <li><a href="/invest">💵 Invertir</a></li>
            <li><a href="/withdraw" class="active">🤑 Retirar</a></li>
            <li><a href="/referrals">👥 Referidos</a></li>
            <li><a href="/settings">⚙️ Configuración</a></li>
            <li><a href="/logout">🚪 Salir</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h1 style="margin-bottom: 30px;">Retirar Fondos</h1>
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px;">Balance disponible: ${{ '%.2f' | format(user.balance) }}</h3>
            <p>No hay mínimo de retiro. Los fondos se envían a tu dirección BEP20 registrada.</p>
        </div>
        
        {% if user.wallet_address %}
        <form method="post">
            <div class="form-group">
                <label>Monto a retirar (USDT)</label>
                <input type="number" name="amount" class="form-control" min="0.1" max="{{ user.balance }}" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Dirección BEP20 de retiro</label>
                <input type="text" name="wallet_address" class="form-control" value="{{ user.wallet_address }}" required>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Solicitar Retiro</button>
                <button type="button" class="btn btn-outline" onclick="window.location.href='/dashboard'">Cancelar</button>
            </div>
        </form>
        {% else %}
        <div class="alert alert-error">
            Debes configurar tu dirección de retiro en la sección de Configuración antes de poder retirar fondos.
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="window.location.href='/settings'">Configurar Wallet</button>
        </div>
        {% endif %}
        
        <h2 style="margin: 40px 0 20px;">Historial de Retiros</h2>
        {% if withdrawals %}
        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.1);">
                        <th style="padding: 15px; text-align: left;">Monto</th>
                        <th style="padding: 15px; text-align: left;">Dirección</th>
                        <th style="padding: 15px; text-align: left;">Fecha</th>
                        <th style="padding: 15px; text-align: left;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wd in withdrawals %}
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px;">${{ '%.2f' | format(wd.amount) }}</td>
                        <td style="padding: 15px;">{{ wd.wallet_address[:6] }}...{{ wd.wallet_address[-4:] }}</td>
                        <td style="padding: 15px;">{{ wd.date }}</td>
                        <td style="padding: 15px; color: {% if wd.status == 'completed' %}#4cd137{% else %}#f39c12{% endif %};">{{ wd.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No hay retiros registrados.</p>
        {% endif %}
    </div>
</div>
""")

referrals_html = base_html.replace("{{ content | safe }}", """
<div class="dashboard">
    <div class="sidebar">
        <h3 style="margin-bottom: 30px; color: var(--accent);">CRYPTOMAX PRO</h3>
        <ul class="sidebar-nav">
            <li><a href="/dashboard">📊 Panel</a></li>
            <li><a href="/invest">💵 Invertir</a></li>
            <li><a href="/withdraw">🤑 Retirar</a></li>
            <li><a href="/referrals" class="active">👥 Referidos</a></li>
            <li><a href="/settings">⚙️ Configuración</a></li>
            <li><a href="/logout">🚪 Salir</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h1 style="margin-bottom: 30px;">Programa de Referidos</h1>
        
        <div style="background: rgba(255,138,0,0.1); padding: 20px; border-radius: 10px; border-left: 4px solid var(--accent); margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px;">💡 Gana con tus referidos</h3>
            <p>Gana el 10% de las ganancias de tus referidos de primer nivel, 3% de segundo nivel y 1% de tercer nivel.</p>
            <p>Tu código único: <strong>{{ user.ref_code }}</strong></p>
        </div>
        
        <h2 style="margin-bottom: 20px;">Tus Enlaces de Referido</h2>
        <div class="referral-link">
            https://{{ request.host }}/register?ref={{ user.ref_code }}
        </div>
        
        <div class="referral-levels">
            <div class="referral-level">
                <h3>Nivel 1 (10%)</h3>
                <p>Referidos directos: {{ level1_count }}</p>
                <p>Ganancias: ${{ '%.2f' | format(level1_earnings) }}</p>
            </div>
            <div class="referral-level">
                <h3>Nivel 2 (3%)</h3>
                <p>Referidos: {{ level2_count }}</p>
                <p>Ganancias: ${{ '%.2f' | format(level2_earnings) }}</p>
            </div>
            <div class="referral-level">
                <h3>Nivel 3 (1%)</h3>
                <p>Referidos: {{ level3_count }}</p>
                <p>Ganancias: ${{ '%.2f' | format(level3_earnings) }}</p>
            </div>
        </div>
        
        <h2 style="margin: 40px 0 20px;">Lista de Referidos</h2>
        {% if referrals %}
        <div style="background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.1);">
                        <th style="padding: 15px; text-align: left;">Usuario</th>
                        <th style="padding: 15px; text-align: left;">Nivel</th>
                        <th style="padding: 15px; text-align: left;">Fecha</th>
                        <th style="padding: 15px; text-align: left;">Ganancias</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ref in referrals %}
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px;">{{ ref.username }}</td>
                        <td style="padding: 15px;">{{ ref.level }}</td>
                        <td style="padding: 15px;">{{ ref.date }}</td>
                        <td style="padding: 15px; color: #4cd137;">${{ '%.2f' | format(ref.earnings) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No tienes referidos aún. Comparte tu enlace para empezar a ganar.</p>
        {% endif %}
    </div>
</div>
""")

settings_html = base_html.replace("{{ content | safe }}", """
<div class="dashboard">
    <div class="sidebar">
        <h3 style="margin-bottom: 30px; color: var(--accent);">CRYPTOMAX PRO</h3>
        <ul class="sidebar-nav">
            <li><a href="/dashboard">📊 Panel</a></li>
            <li><a href="/invest">💵 Invertir</a></li>
            <li><a href="/withdraw">🤑 Retirar</a></li>
            <li><a href="/referrals">👥 Referidos</a></li>
            <li><a href="/settings" class="active">⚙️ Configuración</a></li>
            <li><a href="/logout">🚪 Salir</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h1 style="margin-bottom: 30px;">Configuración de Cuenta</h1>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <h2 style="margin-bottom: 20px;">Información Personal</h2>
                <form method="post" action="/update_profile">
                    <div class="form-group">
                        <label>Nombre de usuario</label>
                        <input type="text" class="form-control" value="{{ user.username }}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Correo electrónico</label>
                        <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
                    </div>
                    <div class="form-group">
                        <label>Dirección BEP20 para retiros</label>
                        <input type="text" name="wallet_address" class="form-control" value="{{ user.wallet_address }}" required placeholder="Ej: 0x123...abc">
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
            
            <div>
                <h2 style="margin-bottom: 20px;">Seguridad</h2>
                <form method="post" action="/change_password">
                    <div class="form-group">
                        <label>Contraseña actual</label>
                        <input type="password" name="current_password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Nueva contraseña</label>
                        <input type="password" name="new_password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Confirmar nueva contraseña</label>
                        <input type="password" name="confirm_password" class="form-control" required>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
""")

# Rutas
@app.route("/")
def home():
    if 'user_id' in session:
        return redirect('/dashboard')
    return render_template_string(base_html.replace("{{ content | safe }}", """
    <div class="hero">
        <div class="hero-content">
            <h1>Minería en la Nube con 5.3% Diario</h1>
            <p>La plataforma más avanzada con inteligencia artificial para maximizar tus ganancias</p>
            <div class="btn-group">
                <button onclick="location.href='/login'" class="btn btn-primary">Iniciar Sesión</button>
                <button onclick="location.href='/register'" class="btn btn-outline">Registrarse</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h2 class="text-center">Nuestros Planes de Inversión</h2>
        <div class="plans">
            <div class="plan-card">
                <h3>Plan Básico</h3>
                <div class="price">4.2% Diario</div>
                <ul>
                    <li>✔️ Inversión mínima: $100</li>
                    <li>✔️ Retiros diarios</li>
                    <li>✔️ Soporte 24/7</li>
                </ul>
                <button class="btn btn-primary" style="width: 100%;">Seleccionar</button>
            </div>
            <div class="plan-card" style="border: 2px solid var(--accent);">
                <h3>Plan Premium</h3>
                <div class="price">5.3% Diario</div>
                <ul>
                    <li>✔️ Inversión mínima: $1,000</li>
                    <li>✔️ Retiros instantáneos</li>
                    <li>✔️ +5% en referidos</li>
                    <li>✔️ Asesor personal</li>
                </ul>
                <button class="btn btn-primary" style="width: 100%; background: var(--accent);">Seleccionar</button>
            </div>
            <div class="plan-card">
                <h3>Plan VIP</h3>
                <div class="price">6.1% Diario</div>
                <ul>
                    <li>✔️ Inversión mínima: $10,000</li>
                    <li>✔️ Retiros prioritarios</li>
                    <li>✔️ +10% en referidos</li>
                    <li>✔️ Estrategias personalizadas</li>
                </ul>
                <button class="btn btn-primary" style="width: 100%;">Seleccionar</button>
            </div>
        </div>
    </div>
    """))

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        
        conn = sqlite3.connect('cryptomax.db')
        c = conn.cursor()
        c.execute("SELECT id, username FROM users WHERE username = ? AND password = ?", (username, password))
        user = c.fetchone()
        conn.close()
        
        if user:
            session['user_id'] = user[0]
            session['username'] = user[1]
            return redirect('/dashboard')
        else:
            return render_template_string(login_html.replace("<form method", """
            <div class="alert alert-error">Usuario o contraseña incorrectos</div>
            <form method
            """))
    
    return render_template_string(login_html)

@app.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form["username"]
        email = request.form["email"]
        password = request.form["password"]
        confirm_password = request.form["confirm_password"]
        ref_code = request.form["ref_code"]
        
        if password != confirm_password:
            return render_template_string(register_html.replace("<form method", """
            <div class="alert alert-error">Las contraseñas no coinciden</div>
            <form method
            """))
        
        try:
            ip_address = get_client_ip()
            user_ref_code = generate_ref_code(username, ip_address)
            
            conn = sqlite3.connect('cryptomax.db')
            c = conn.cursor()
            
            # Registrar usuario
            c.execute("INSERT INTO users (username, password, email, ref_code, joined_at) VALUES (?, ?, ?, ?, ?)",
                     (username, password, email, user_ref_code, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
            user_id = c.lastrowid
            
            # Registrar referido si aplica
            if ref_code:
                c.execute("SELECT id FROM users WHERE ref_code = ?", (ref_code,))
                referrer = c.fetchone()
                if referrer:
                    referrer_id = referrer[0]
                    c.execute("INSERT INTO referrals (referrer_id, referred_id, level, date) VALUES (?, ?, ?, ?)",
                             (referrer_id, user_id, 1, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
            
            conn.commit()
            conn.close()
            
            return render_template_string(register_html.replace("<form method", """
            <div class="alert alert-success">¡Cuenta creada con éxito! <a href="/login" style="color: white;">Inicia sesión</a></div>
            <form method
            """))
        except sqlite3.IntegrityError:
            return render_template_string(register_html.replace("<form method", """
            <div class="alert alert-error">El usuario ya existe</div>
            <form method
            """))
    
    # Mostrar formulario con código de referido si viene en la URL
    ref_code = request.args.get('ref', '')
    register_with_ref = register_html.replace('placeholder="Código de Referido (opcional)"', 
                                           f'placeholder="Código de Referido (opcional)" value="{ref_code}"')
    return render_template_string(register_with_ref)

@app.route("/dashboard")
def dashboard():
    if 'user_id' not in session:
        return redirect('/login')
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    # Obtener datos del usuario
    c.execute("SELECT username, balance, ref_code FROM users WHERE id = ?", (session['user_id'],))
    user_data = c.fetchone()
    user = {
        'username': user_data[0],
        'balance': user_data[1] or 0,
        'ref_code': user_data[2] or 'N/A'
    }
    
    # Obtener inversiones
    c.execute("SELECT plan, amount, date FROM investments WHERE user_id = ?", (session['user_id'],))
    investments = [{'plan': row[0], 'amount': row[1], 'date': row[2]} for row in c.fetchall()]
    total_invested = sum(inv['amount'] for inv in investments)
    
    # Contar referidos
    c.execute("SELECT COUNT(*) FROM referrals WHERE referrer_id = ? AND level = 1", (session['user_id'],))
    referrals = c.fetchone()[0]
    
    conn.close()
    
    return render_template_string(dashboard_html, 
                                user=user, 
                                investments=investments, 
                                total_invested=total_invested,
                                referrals=referrals,
                                days_passed=days_passed)

@app.route("/invest", methods=["GET", "POST"])
def invest():
    if 'user_id' not in session:
        return redirect('/login')
    
    if request.method == "POST":
        amount = float(request.form["amount"])
        plan = request.form["plan"]
        tx_hash = request.form["tx_hash"]
        
        if amount < 1 or amount > 1000:
            return render_template_string(invest_html.replace("<form method", """
            <div class="alert alert-error">El monto debe estar entre 1 y 1000 USDT</div>
            <form method
            """))
        
        conn = sqlite3.connect('cryptomax.db')
        c = conn.cursor()
        
        # Registrar inversión
        c.execute("INSERT INTO investments (user_id, amount, plan, date, tx_hash) VALUES (?, ?, ?, ?, ?)",
                 (session['user_id'], amount, plan, datetime.now().strftime('%Y-%m-%d %H:%M:%S'), tx_hash))
        
        # Actualizar balance (simulando ganancias)
        c.execute("UPDATE users SET balance = balance + ? WHERE id = ?", (amount, session['user_id']))
        
        conn.commit()
        conn.close()
        
        return render_template_string(invest_html.replace("<form method", """
        <div class="alert alert-success">¡Inversión registrada con éxito! Las ganancias comenzarán a generarse en breve.</div>
        <form method
        """))
    
    # Obtener datos del usuario para mostrar en el template
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    c.execute("SELECT username, balance, ref_code FROM users WHERE id = ?", (session['user_id'],))
    user_data = c.fetchone()
    user = {
        'username': user_data[0],
        'balance': user_data[1] or 0,
        'ref_code': user_data[2] or 'N/A'
    }
    conn.close()
    
    return render_template_string(invest_html, user=user)

@app.route("/withdraw", methods=["GET", "POST"])
def withdraw():
    if 'user_id' not in session:
        return redirect('/login')
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    # Obtener datos del usuario
    c.execute("SELECT username, balance, ref_code, wallet_address FROM users WHERE id = ?", (session['user_id'],))
    user_data = c.fetchone()
    user = {
        'username': user_data[0],
        'balance': user_data[1] or 0,
        'ref_code': user_data[2] or 'N/A',
        'wallet_address': user_data[3] or ''
    }
    
    if request.method == "POST":
        amount = float(request.form["amount"])
        wallet_address = request.form["wallet_address"]
        
        if amount <= 0 or amount > user['balance']:
            return render_template_string(withdraw_html.replace("<form method", """
            <div class="alert alert-error">Monto inválido o insuficiente balance</div>
            <form method
            """), user=user, withdrawals=[])
        
        # Registrar retiro
        c.execute("INSERT INTO withdrawals (user_id, amount, wallet_address, date) VALUES (?, ?, ?, ?)",
                 (session['user_id'], amount, wallet_address, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
        
        # Actualizar balance
        c.execute("UPDATE users SET balance = balance - ? WHERE id = ?", (amount, session['user_id']))
        
        conn.commit()
        
        return render_template_string(withdraw_html.replace("<form method", """
        <div class="alert alert-success">¡Retiro solicitado con éxito! Será procesado en las próximas 24 horas.</div>
        <form method
        """), user=user, withdrawals=[])
    
    # Obtener historial de retiros
    c.execute("SELECT amount, wallet_address, date, status FROM withdrawals WHERE user_id = ? ORDER BY date DESC", (session['user_id'],))
    withdrawals = [{
        'amount': row[0],
        'wallet_address': row[1],
        'date': row[2],
        'status': row[3]
    } for row in c.fetchall()]
    
    conn.close()
    
    return render_template_string(withdraw_html, user=user, withdrawals=withdrawals)

@app.route("/referrals")
def referrals():
    if 'user_id' not in session:
        return redirect('/login')
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    # Obtener datos del usuario
    c.execute("SELECT username, balance, ref_code FROM users WHERE id = ?", (session['user_id'],))
    user_data = c.fetchone()
    user = {
        'username': user_data[0],
        'balance': user_data[1] or 0,
        'ref_code': user_data[2] or 'N/A'
    }
    
    # Obtener estadísticas de referidos
    c.execute("SELECT COUNT(*), SUM(earnings) FROM referrals WHERE referrer_id = ? AND level = 1", (session['user_id'],))
    level1 = c.fetchone()
    level1_count = level1[0] if level1[0] else 0
    level1_earnings = level1[1] if level1[1] else 0
    
    c.execute("SELECT COUNT(*), SUM(earnings) FROM referrals WHERE referrer_id = ? AND level = 2", (session['user_id'],))
    level2 = c.fetchone()
    level2_count = level2[0] if level2[0] else 0
    level2_earnings = level2[1] if level2[1] else 0
    
    c.execute("SELECT COUNT(*), SUM(earnings) FROM referrals WHERE referrer_id = ? AND level = 3", (session['user_id'],))
    level3 = c.fetchone()
    level3_count = level3[0] if level3[0] else 0
    level3_earnings = level3[1] if level3[1] else 0
    
    # Obtener lista de referidos
    c.execute('''SELECT u.username, r.level, r.date, r.earnings 
                FROM referrals r JOIN users u ON r.referred_id = u.id 
                WHERE r.referrer_id = ? ORDER BY r.date DESC''', (session['user_id'],))
    referrals_list = [{
        'username': row[0],
        'level': row[1],
        'date': row[2],
        'earnings': row[3] or 0
    } for row in c.fetchall()]
    
    conn.close()
    
    return render_template_string(referrals_html, 
                               user=user,
                               level1_count=level1_count,
                               level1_earnings=level1_earnings,
                               level2_count=level2_count,
                               level2_earnings=level2_earnings,
                               level3_count=level3_count,
                               level3_earnings=level3_earnings,
                               referrals=referrals_list)

@app.route("/settings", methods=["GET", "POST"])
def settings():
    if 'user_id' not in session:
        return redirect('/login')
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    # Obtener datos del usuario
    c.execute("SELECT username, email, wallet_address FROM users WHERE id = ?", (session['user_id'],))
    user_data = c.fetchone()
    user = {
        'username': user_data[0],
        'email': user_data[1],
        'wallet_address': user_data[2] or ''
    }
    
    conn.close()
    
    return render_template_string(settings_html, user=user)

@app.route("/update_profile", methods=["POST"])
def update_profile():
    if 'user_id' not in session:
        return redirect('/login')
    
    email = request.form["email"]
    wallet_address = request.form["wallet_address"]
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    c.execute("UPDATE users SET email = ?, wallet_address = ? WHERE id = ?", 
             (email, wallet_address, session['user_id']))
    
    conn.commit()
    conn.close()
    
    return redirect('/settings')

@app.route("/change_password", methods=["POST"])
def change_password():
    if 'user_id' not in session:
        return redirect('/login')
    
    current_password = request.form["current_password"]
    new_password = request.form["new_password"]
    confirm_password = request.form["confirm_password"]
    
    if new_password != confirm_password:
        return render_template_string(settings_html.replace("<form method", """
        <div class="alert alert-error">Las contraseñas no coinciden</div>
        <form method
        """))
    
    conn = sqlite3.connect('cryptomax.db')
    c = conn.cursor()
    
    # Verificar contraseña actual
    c.execute("SELECT password FROM users WHERE id = ?", (session['user_id'],))
    db_password = c.fetchone()[0]
    
    if db_password != current_password:
        conn.close()
        return render_template_string(settings_html.replace("<form method", """
        <div class="alert alert-error">La contraseña actual es incorrecta</div>
        <form method
        """))
    
    # Actualizar contraseña
    c.execute("UPDATE users SET password = ? WHERE id = ?", (new_password, session['user_id']))
    
    conn.commit()
    conn.close()
    
    return render_template_string(settings_html.replace("<form method", """
    <div class="alert alert-success">¡Contraseña actualizada con éxito!</div>
    <form method
    """))

@app.route("/logout")
def logout():
    session.clear()
    return redirect('/login')

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080, debug=True)